{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ game.title }}</title>
    <meta charset="UTF-8">
    <script src="{% static "jspsych-6.0.5/jspsych.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-html-button-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-image-button-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-audio-button-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-audio-keyboard-response.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-video.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-fullscreen.js" %}"></script>
    <script src="{% static "jspsych-6.0.5/plugins/jspsych-categorize-html.js" %}"></script>
    <script src="{% static "jquery-3.4.1/jquery-3.4.1.min.js" %}"></script>
    <link rel="stylesheet" href="{% static 'jspsych-6.0.5/css/jspsych.css' %}">
</head>
<body>
<script type="text/javascript">
    var timeline = [];
    var start_time_list = [];
    var end_time_list = [];
    const average = arr => arr.reduce((p, c) => p + c, 0) / arr.length;
    {#timeline.push({#}
    {#    type: 'fullscreen',#}
    {#});#}

        {% for sequence in data.sequences.pre_sequence %}
            {% include 'game/include/timeline.html' %}
        {% endfor %}
        {% for sequence in data.sequences.main_sequence %}
            {% include 'game/include/timeline.html' %}
        {% endfor %}
        {% for sequence in data.sequences.post_sequence %}
            {% include 'game/include/timeline.html' %}
        {% endfor %}


    timeline.push({
        type: 'html-keyboard-response',
        stimulus: function () {
            var trials = jsPsych.data.get().filterCustom(function (data) {
                return data.test_part === 'test';
            });
            var rt = null;
            if (trials.count() > 0) {
                var correct_trials = trials.filter({correct: true});
                var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
                rt = trials.select('rt').values;
                console.log(accuracy);
                console.log(start_time_list);
                console.log(end_time_list);
                console.log(rt);
                /* yumin accuracy */
                return "</p><p>아무 키나 누르세요.</p>";
            } else {
                rt = trials.select('rt').values;
                console.log(start_time_list);
                console.log(end_time_list);
                console.log(rt);
                /* yumin no accuracy */
                return "</p><p>아무 키나 누르세요.</p>";
            }
        },
        trial_duration: 10000,
    });

    jsPsych.init({
        timeline: timeline,
        show_preload_progress_bar: true,
        on_finish: function () {
            // jsPsych.data.get().localSave('csv', 'data.csv');
            var json_result = jsPsych.data.get().json();
            $.ajax({
                type: "POST",
                data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'json_result': json_result},
                dataType: "json",
                success: function (response) {
                    alert(response.message);
                    window.location.href = '{% url 'participate:game_result' research_hex=research_hex game_id=game.id %}';
                },
                error: function (response) {
                    alert('알 수 없는 문제가 발생했습니다.')
                }
            })
        }
    })
</script>
</body>


